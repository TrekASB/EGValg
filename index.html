<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Property Objektliste (Rask versjon)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
  <style>
    :root { --primary: #0069d9; --success: #28a745; --danger: #e74c3c; --border: #dee2e6; --light-bg: #f8f9fa; }
    body { margin:0; font-family:'Segoe UI',sans-serif; background:linear-gradient(135deg,#f5f7fa,#e4edf5); color:#333; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
    header { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); padding:18px 24px; border-bottom:1px solid var(--border); box-shadow:0 4px 12px rgba(0,0,0,0.08); display:flex; flex-wrap:wrap; align-items:center; gap:18px; z-index:10; }
    .logo { width:48px; height:48px; border-radius:8px; object-fit:contain; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .title { font-size:22px; font-weight:700; color:var(--primary); margin:0; }
    select, button { padding:10px 16px; border-radius:8px; border:1px solid var(--border); font-size:14px; transition:all .2s; }
    select { background:white; min-width:180px; }
    button { background:var(--primary); color:white; border:none; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:6px; }
    button:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
    button#scanButton { background:var(--success); }
    button#resetButton { background:var(--danger); }
    button#resetButton:hover:not(:disabled) { background:#c0392b; }
    button:disabled { background:#6c757d; cursor:not-allowed; }
    .prop-group { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    main { flex:1; padding:24px; overflow-y:auto; }
    #status, #error { text-align:center; font-size:16px; padding:12px; border-radius:8px; margin-bottom:20px; }
    #status { background:rgba(40,167,69,0.1); color:var(--success); border:1px solid rgba(40,167,69,0.2); }
    #error { background:rgba(220,53,69,0.1); color:var(--danger); border:1px solid rgba(220,53,69,0.2); }
    .result-card { background:white; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.1); padding:24px; margin-bottom:30px; }
    .result-card h3 { margin-top:0; color:var(--primary); }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:12px; text-align:left; border-bottom:1px solid var(--border); }
    th { background:var(--light-bg); }
    .count-link { color:var(--primary); font-weight:600; cursor:pointer; text-decoration:underline; }
    .count-link:hover { color:var(--danger); }
    .with { color:var(--success); }
    .without { color:var(--danger); }
    .reference-section { margin-top:20px; font-weight:600; color:var(--danger); font-size:16px; }
  </style>
</head>
<body>
  <header>
    <div class="title-container">
      <img src="https://norconsult.com/wp-content/uploads/2023/09/norconsult-logo-2023.svg" alt="Norconsult Logo" class="logo">
      <h1 class="title">Multi-Property Objektliste (Rask)</h1>
    </div>
    <label>Property Set: <select id="psetSelect"><option value="">(velg‚Ä¶)</option></select></label>
    <div class="prop-group">
      <label><input type="checkbox" id="cb1"> Property 1: <select id="prop1" disabled><option>(ingen)</option></select></label>
      <label><input type="checkbox" id="cb2"> Property 2: <select id="prop2" disabled><option>(ingen)</option></select></label>
      <label><input type="checkbox" id="cb3"> Property 3: <select id="prop3" disabled><option>(ingen)</option></select></label>
      <label><input type="checkbox" id="cb4"> Property 4: <select id="prop4" disabled><option>(ingen)</option></select></label>
    </div>
    <div style="display:flex;gap:12px;">
      <button id="scanButton">üîÑ Oppdater liste</button>
      <button id="loadButton" disabled>üìä Hent oversikt</button>
      <button id="colorizeButton" disabled>üé® Fargelegg alle</button>
      <button id="resetButton" disabled>üîÑ Tilbakestill</button>
    </div>
  </header>
  <main>
    <div id="status">Kobler til Trimble Connect‚Ä¶</div>
    <div id="error"></div>
    <div id="resultsContainer"></div>
  </main>

  <script>
    let API = null;
    let availableProps = {};
    let modelData = []; // For lagring av selection under lasting
    let lastSelections = new Map();

    async function connect() {
      API = await TrimbleConnectWorkspace.connect(window.parent, () => {}, 30000);
      document.getElementById("status").textContent = "‚úÖ Tilkoblet ‚Äì trykk ¬´Oppdater liste¬ª.";
    }

    function clearResults() {
      document.getElementById("resultsContainer").innerHTML = "";
      lastSelections.clear();
      modelData = [];
    }

    function populatePropSelects(psetName) {
      const selects = ["prop1","prop2","prop3","prop4"].map(id => document.getElementById(id));
      const cbs = ["cb1","cb2","cb3","cb4"].map(id => document.getElementById(id));
      selects.forEach(s => { s.innerHTML = '<option value="">(ingen)</option>'; s.disabled = true; });
      cbs.forEach(cb => cb.checked = false);
      if (!psetName || !availableProps[psetName]) return;
      const props = Array.from(availableProps[psetName]).sort((a,b) => a.localeCompare(b,"nb"));
      selects.forEach(sel => {
        props.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p; opt.textContent = p;
          sel.appendChild(opt);
        });
        sel.disabled = false;
      });
    }

    async function scanProperties() {
      clearResults();
      document.getElementById("error").textContent = "";
      const status = document.getElementById("status");
      status.textContent = "üîç Skanner Property Sets (rask skanning)‚Ä¶";

      availableProps = {};
      const models = await API.viewer.getObjects();

      // Kun samle Psets og properties ‚Äì ingen full property henting
      for (const m of models) {
        const modelId = m.modelId || m.modelid || m["model Id"];
        if (!modelId) continue;
        // Vi hopper over full getObjectProperties her for hastighet
        // (Vi bruker det senere kun n√•r n√∏dvendig)
      }

      // For √• f√• Psets m√• vi dessverre hente properties ‚Äì men vi gj√∏r det minimalt
      for (const m of models) {
        const modelId = m.modelId || m.modelid || m["model Id"];
        const objs = m.objects || [];
        if (!modelId || !objs.length) continue;
        const runtimeIds = objs.slice(0, 100); // Kun f√∏rste 100 objekter for rask skanning av Psets!
        const objProps = await API.viewer.getObjectProperties(modelId, runtimeIds);
        for (const obj of objProps) {
          for (const pset of obj.properties || []) {
            const name = pset.name || "";
            if (!name) continue;
            if (!availableProps[name]) availableProps[name] = new Set();
            for (const p of pset.properties || []) {
              if (p.name) availableProps[name].add(p.name);
            }
          }
        }
      }

      const sel = document.getElementById("psetSelect");
      sel.innerHTML = '<option value="">(velg‚Ä¶)</option>';
      Object.keys(availableProps).sort((a,b)=>a.localeCompare(b,"nb")).forEach(n => {
        const opt = document.createElement("option");
        opt.value = n; opt.textContent = n;
        sel.appendChild(opt);
      });

      status.textContent = `‚úÖ Skanning ferdig ‚Äì fant ${Object.keys(availableProps).length} Property Sets. Velg og hent oversikt!`;
      document.getElementById("loadButton").disabled = false;
    }

    async function loadAllLists() {
      clearResults();
      const pset = document.getElementById("psetSelect").value;
      if (!pset) return document.getElementById("error").textContent = "Velg Property Set";

      const selectedProps = [];
      for (let i=1; i<=4; i++) {
        const cb = document.getElementById(`cb${i}`);
        if (cb.checked) {
          const val = document.getElementById(`prop${i}`).value;
          if (val && val !== "(ingen)") selectedProps.push(val);
        }
      }
      if (selectedProps.length === 0) return document.getElementById("error").textContent = "Huk av minst √©n property";

      document.getElementById("status").textContent = `üìä Henter data (kan ta tid i store modeller)‚Ä¶`;

      const container = document.getElementById("resultsContainer");
      const table = document.createElement("table");
      table.innerHTML = `<thead><tr><th>Property</th><th>Med verdi</th><th>Uten verdi (klikk for isolering)</th></tr></thead><tbody></tbody>`;
      const tbody = table.querySelector("tbody");

      for (const prop of selectedProps) {
        const { counts, selection } = await getPropertyData(pset, prop); // Full henting her
        lastSelections.set(prop, selection);

        const row = document.createElement("tr");
        row.innerHTML = `<td><strong>${prop}</strong></td>
          <td class="with">${counts.withValue}</td>
          <td class="without"><span class="count-link" data-prop="${prop}">${counts.withoutValue}</span></td>`;
        tbody.appendChild(row);
      }

      container.appendChild(table);

      // Klikk p√• uten verdi-tall for isolering
      container.querySelectorAll(".count-link").forEach(link => {
        link.onclick = async () => {
          const prop = link.dataset.prop;
          const sel = lastSelections.get(prop);
          // Isol√©r uten verdi
          const list = [];
          const modelMap = {};
          sel.withoutValue.forEach(o => {
            if (!modelMap[o.modelId]) modelMap[o.modelId] = [];
            modelMap[o.modelId].push(o.runtimeId);
          });
          for (const modelId in modelMap) {
            list.push({ modelId, objectRuntimeIds: modelMap[modelId] });
          }
          await API.viewer.isolateEntities(list);
          document.getElementById("status").textContent = `üîç Isolert ${sel.withoutValue.length} objekter uten verdi for "${prop}"`;
        };
      });

      // Pset Reference Object
      const ref = document.createElement("div");
      ref.className = "reference-section";
      ref.textContent = "Pset Reference Object ‚Äì Klikk p√• tall i 'Uten verdi' for isolering av objekter uten verdi.";
      container.appendChild(ref);

      document.getElementById("status").textContent = "‚úÖ Oversikt ferdig! Klikk p√• tall for isolering.";
      document.getElementById("colorizeButton").disabled = false;
      document.getElementById("resetButton").disabled = false;
    }

    // getPropertyData, colorizeAll, resetAll fra forrige (med full henting, men kun n√•r du trykker "Hent oversikt")

    async function getPropertyData(psetName, propName) {
      const counts = { withValue: 0, withoutValue: 0 };
      const selection = { withValue: {}, withoutValue: [] };

      const models = await API.viewer.getObjects();

      for (const m of models) {
        const modelId = m.modelId || m.modelid || m["model Id"];
        const modelName = m.name || m.filename || "Ukjent";
        const objs = m.objects || [];
        if (!modelId || !objs.length) continue;

        const runtimeIds = objs.map(o => o.id);
        const objProps = await API.viewer.getObjectProperties(modelId, runtimeIds);

        for (const obj of objProps) {
          let hasProp = false;
          let hasValue = false;

          for (const ps of obj.properties || []) {
            if (ps.name !== psetName) continue;
            for (const p of ps.properties || []) {
              if (p.name === propName) {
                hasProp = true;
                const v = p.value;
                if (v !== null && v !== undefined && String(v).trim() !== "") hasValue = true;
                break;
              }
            }
            if (hasProp) break;
          }

          const key = hasProp && hasValue ? "withValue" : "withoutValue";
          counts[key]++;

          if (key === "withValue") {
            if (!selection.withValue[modelId]) selection.withValue[modelId] = [];
            selection.withValue[modelId].push(obj.id);
          } else if (hasProp) {
            selection.withoutValue.push({
              modelId,
              modelName,
              runtimeId: obj.id,
              guid: obj.globalId || "Ukjent"
            });
          }
        }
      }
      return { counts, selection };
    }

    async function colorizeAll() {
      await API.viewer.setObjectState(undefined, { color: "reset" });
      for (const [prop, sel] of lastSelections) {
        // Gr√∏nn med verdi
        for (const modelId in sel.withValue) {
          await API.viewer.setObjectState({ modelObjectIds: [{ modelId, objectRuntimeIds: sel.withValue[modelId] }] }, { color: { r:46, g:204, b:113, a:255 } });
        }
        // R√∏d uten verdi
        const map = {};
        sel.withoutValue.forEach(o => {
          if (!map[o.modelId]) map[o.modelId] = [];
          map[o.modelId].push(o.runtimeId);
        });
        for (const modelId in map) {
          await API.viewer.setObjectState({ modelObjectIds: [{ modelId, objectRuntimeIds: map[modelId] }] }, { color: { r:231, g:76, b:60, a:255 } });
        }
      }
      document.getElementById("status").textContent = "üé® Fargelagt (gr√∏nn=med, r√∏d=uten)";
    }

    async function resetAll() {
      clearResults();
      await API.viewer.setObjectState(undefined, { color: "reset" });
      await API.viewer.isolateEntities([]);
      document.getElementById("status").textContent = "üîÑ Tilbakestilt";
      document.getElementById("colorizeButton").disabled = true;
      document.getElementById("resetButton").disabled = true;
    }

    document.getElementById("scanButton").onclick = scanProperties;
    document.getElementById("loadButton").onclick = loadAllLists;
    document.getElementById("colorizeButton").onclick = colorizeAll;
    document.getElementById("resetButton").onclick = resetAll;
    document.getElementById("psetSelect").onchange = e => populatePropSelects(e.target.value);

    connect().catch(e => document.getElementById("error").textContent = "Feil: " + e.message);
  </script>
</body>
</html>
