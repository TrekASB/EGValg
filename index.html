<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property-verdi kakediagram (opptil 4)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Trimble Connect Workspace API -->
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    header .title {
      font-weight: 600;
      margin-right: 8px;
      white-space: nowrap;
    }

    header button {
      font-size: 13px;
      padding: 4px 8px;
      cursor: pointer;
      white-space: nowrap;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
      gap: 8px;
    }

    #status {
      font-size: 13px;
      opacity: 0.9;
      min-height: 18px;
    }

    #error {
      font-size: 13px;
      color: #b00020;
      min-height: 18px;
    }

    #configContainer {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      margin-top: 4px;
    }

    .config-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 6px;
      background: #f5f5f5;
    }

    .config-label {
      font-weight: 600;
      margin-right: 4px;
    }

    .config-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .config-row select {
      font-size: 13px;
      padding: 2px 4px;
      max-width: 210px;
    }

    #chartsWrapper {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .chart-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #fff;
      min-height: 220px;
    }

    .chart-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      flex-wrap: wrap;
    }

    .chart-title {
      font-weight: 600;
    }

    .chart-card-header button {
      font-size: 12px;
      padding: 3px 8px;
      cursor: pointer;
      white-space: nowrap;
    }

    .chart-info {
      font-size: 12px;
      opacity: 0.9;
      min-height: 16px;
    }

    canvas {
      max-width: 480px;
      max-height: 480px;
      width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">Property-verdi kakediagram (opptil 4)</div>
    <button id="scanButton">Oppdater liste fra modell</button>
    <button id="reloadButton" disabled>Hent fra modell</button>
  </header>

  <main>
    <div id="status">Kobler til Trimble Connect…</div>

    <div id="configContainer">
      <div class="config-row" data-slot="0">
        <span class="config-label">Oppsett 1:</span>
        <label>
          Property set:
          <select class="pset-select" id="psetSelect-0" data-slot="0">
            <option value="">(velg…)</option>
          </select>
        </label>
        <label>
          Property:
          <select class="prop-select" id="propSelect-0" data-slot="0" disabled>
            <option value="">(velg…)</option>
          </select>
        </label>
      </div>

      <div class="config-row" data-slot="1">
        <span class="config-label">Oppsett 2:</span>
        <label>
          Property set:
          <select class="pset-select" id="psetSelect-1" data-slot="1">
            <option value="">(velg…)</option>
          </select>
        </label>
        <label>
          Property:
          <select class="prop-select" id="propSelect-1" data-slot="1" disabled>
            <option value="">(velg…)</option>
          </select>
        </label>
      </div>

      <div class="config-row" data-slot="2">
        <span class="config-label">Oppsett 3:</span>
        <label>
          Property set:
          <select class="pset-select" id="psetSelect-2" data-slot="2">
            <option value="">(velg…)</option>
          </select>
        </label>
        <label>
          Property:
          <select class="prop-select" id="propSelect-2" data-slot="2" disabled>
            <option value="">(velg…)</option>
          </select>
        </label>
      </div>

      <div class="config-row" data-slot="3">
        <span class="config-label">Oppsett 4:</span>
        <label>
          Property set:
          <select class="pset-select" id="psetSelect-3" data-slot="3">
            <option value="">(velg…)</option>
          </select>
        </label>
        <label>
          Property:
          <select class="prop-select" id="propSelect-3" data-slot="3" disabled>
            <option value="">(velg…)</option>
          </select>
        </label>
      </div>
    </div>

    <div id="error"></div>

    <div id="chartsWrapper">
      <!-- Diagram-kort genereres dynamisk -->
    </div>
  </main>

  <script>
    let API = null;

    // Lagret struktur: psetNavn -> Set(propertyNavn)
    let availableProps = {};

    // Alle objekt-egenskaper (for å slippe å hente flere ganger)
    // [
    //   { modelId, objects: [ { runtimeId, properties: [ {name, properties:[{name,value}]} ] } ] }
    // ]
    let lastAllObjects = null;

    // Per slot: selectionByState
    // selectionStatesBySlot[slotIndex] = { withValue: { modelId:[ids] }, withoutValue:{ modelId:[ids] } }
    let selectionStatesBySlot = {};

    // Per slot: Chart.js instans
    let chartInstances = {};

    // Farger til kakediagram og modell
    const GROUP_COLORS = {
      withValue: "rgb(55, 130, 70)",    // med verdi
      withoutValue: "rgb(200, 60, 60)"  // uten verdi
    };

    function parseRgbToRgba(rgbString) {
      if (!rgbString) return null;
      const match = rgbString.match(/rgb\\s*\\(\\s*(\\d+)\\s*,\\s*(\\d+)\\s*,\\s*(\\d+)\\s*\\)/i);
      if (!match) return null;
      return {
        r: parseInt(match[1], 10),
        g: parseInt(match[2], 10),
        b: parseInt(match[3], 10),
        a: 255
      };
    }

    async function connectToWorkspace() {
      API = await TrimbleConnectWorkspace.connect(
        window.parent,
        (event, data) => {
          console.log("TC event:", event, data);
        },
        30000
      );
      document.getElementById("status").textContent =
        "Tilkoblet. Klikk «Oppdater liste fra modell» for å hente PropertySets.";
    }

    function setButtonsEnabled(afterScan) {
      document.getElementById("reloadButton").disabled = !afterScan;
    }

    async function getAllObjectProperties() {
      if (!API) throw new Error("API ikke tilkoblet.");

      const modelObjectsList = await API.viewer.getObjects();
      console.log("getObjects() →", modelObjectsList);

      const result = [];

      for (const modelObjects of modelObjectsList) {
        const modelId =
          modelObjects.modelId ||
          modelObjects.modelid ||
          modelObjects["model Id"];

        const objs = modelObjects.objects || [];
        if (!modelId || !objs.length) continue;

        const runtimeIds = objs.map(o => o.id);
        if (!runtimeIds.length) continue;

        const objectPropsArray = await API.viewer.getObjectProperties(
          modelId,
          runtimeIds
        );

        const objects = objectPropsArray.map(obj => ({
          runtimeId: obj.id,
          properties: obj.properties || []
        }));

        result.push({ modelId, objects });
      }

      return result;
    }

    function populateAllPsetSelects() {
      const psetSelects = document.querySelectorAll(".pset-select");
      const propSelects = document.querySelectorAll(".prop-select");

      // nullstill property-selects
      propSelects.forEach(sel => {
        sel.innerHTML = '<option value="">(velg…)</option>';
        sel.disabled = true;
      });

      const psetNames = Object.keys(availableProps).sort((a, b) =>
        a.localeCompare(b, "nb")
      );

      psetSelects.forEach(select => {
        const prev = select.value;
        select.innerHTML = '<option value="">(velg…)</option>';
        for (const name of psetNames) {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        }
        if (psetNames.includes(prev)) {
          select.value = prev;
        }
      });
    }

    function populatePropSelectForSlot(slotIndex, psetName) {
      const propSelect = document.getElementById(`propSelect-${slotIndex}`);
      if (!propSelect) return;

      propSelect.innerHTML = '<option value="">(velg…)</option>';

      if (!psetName || !availableProps[psetName]) {
        propSelect.disabled = true;
        return;
      }

      const props = Array.from(availableProps[psetName]).sort((a, b) =>
        a.localeCompare(b, "nb")
      );

      for (const p of props) {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        propSelect.appendChild(opt);
      }

      propSelect.disabled = false;
    }

    async function scanAv
